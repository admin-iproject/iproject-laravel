{{-- ============================================================
     PROJECT SHOW â€” MAIN TASK PANEL
     Tab strip + task rows + risk legend
     ============================================================ --}}

{{-- â”€â”€ TASK RISK CALCULATION FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ --}}
@php
if (!defined('TASK_RISK_RATIO')) define('TASK_RISK_RATIO', 1.10);

if (!function_exists('taskRiskColor')) {
    function taskRiskColor($actual, $total, $progress): string {
        if (!$total || $total <= 0) return 'grey';
        if ($actual === null || $actual < 0) return 'grey';
        $consumedRatio = $actual / $total;
        $progressRatio = ($progress > 0) ? ($progress / 100) : 0;
        if ($consumedRatio >= 1.0) return 'red';
        if ($progressRatio <= 0 && $consumedRatio > 0) return 'amber';
        if ($consumedRatio > ($progressRatio * TASK_RISK_RATIO)) return 'amber';
        return 'green';
    }
}

if (!function_exists('taskDateRiskColor')) {
    function taskDateRiskColor($startDate, $endDate, $progress, $isOverdue): string {
        if ($isOverdue) return 'red';
        if (!$startDate || !$endDate) return 'grey';
        $totalDays   = $startDate->diffInDays($endDate);
        if ($totalDays <= 0) return 'grey';
        $elapsedDays = $startDate->diffInDays(now(), false);
        if ($elapsedDays <= 0) return 'green';
        return taskRiskColor($elapsedDays, $totalDays, $progress);
    }
}

if (!function_exists('taskHoursRiskColor')) {
    function taskHoursRiskColor($hoursWorked, $duration, $durationType, $progress): string {
        if (!$duration || $duration <= 0) return 'grey';
        if ($hoursWorked === null) return 'grey';
        $expectedHours = ($durationType == 24) ? ($duration * 8) : $duration;
        return taskRiskColor($hoursWorked, $expectedHours, $progress);
    }
}

if (!function_exists('riskColorClass')) {
    function riskColorClass(string $color): string {
        return match($color) {
            'green' => 'text-green-500',
            'amber' => 'text-amber-500',
            'red'   => 'text-red-500',
            default => 'text-gray-300',
        };
    }
}

if (!function_exists('riskRowBg')) {
    function riskRowBg(string $hours, string $budget, string $date): string {
        $colors = [$hours, $budget, $date];
        if (in_array('red', $colors))   return 'bg-red-50';
        if (in_array('amber', $colors)) return 'bg-amber-50';
        return '';
    }
}

$allTasks      = $project->tasks;
$topLevelTasks = $allTasks->filter(fn($task) => is_null($task->parent_id) || $task->parent_id == $task->id)
                          ->sortBy('task_order');
$phases        = $project->phases ?? [];
@endphp

<div class="widget-card" id="taskListCard">

    {{-- Tab Strip --}}
    <div class="border-b border-gray-200 px-4 flex items-center justify-between">
        <div class="flex items-center gap-0 overflow-x-auto" id="projectTabStrip">
            <button onclick="switchProjectTab('tab-tasks')"
                    class="project-tab active px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-amber-500 text-amber-700 bg-white -mb-px"
                    data-tab="tab-tasks">
                Tasks
                <span class="ml-1 px-1.5 py-0.5 text-xs bg-gray-100 text-gray-600 rounded-full">{{ $stats['total_tasks'] }}</span>
            </button>
            <button onclick="switchProjectTab('tab-overdue')"
                    class="project-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 -mb-px"
                    data-tab="tab-overdue">
                Overdue
                @if($stats['overdue_tasks'] > 0)
                    <span class="ml-1 px-1.5 py-0.5 text-xs bg-red-100 text-red-600 rounded-full">{{ $stats['overdue_tasks'] }}</span>
                @endif
            </button>
            <button onclick="switchProjectTab('tab-files')"
                    class="project-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 -mb-px"
                    data-tab="tab-files">Files</button>
            <button onclick="switchProjectTab('tab-forums')"
                    class="project-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 -mb-px"
                    data-tab="tab-forums">Forums</button>
            <button onclick="switchProjectTab('tab-gantt')"
                    class="project-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 -mb-px"
                    data-tab="tab-gantt">Gantt</button>
            <button onclick="switchProjectTab('tab-log')"
                    class="project-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 -mb-px"
                    data-tab="tab-log">Workflow Log</button>
        </div>
        <button id="openTaskModal"
                class="flex-shrink-0 ml-4 flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-white bg-amber-500 hover:bg-amber-600 rounded-lg transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Add Task
        </button>
    </div>

    {{-- â”€â”€ TAB: TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ --}}
    <div id="tab-tasks" class="tab-content">

        @if($allTasks->count() > 0)

            {{-- Sticky Column Headers --}}
            <div class="sticky top-0 z-10 bg-gray-50 border-b border-gray-200 px-2 py-1.5 grid gap-2 text-xs font-medium text-gray-400 uppercase tracking-wide"
                 style="grid-template-columns: 18px 18px 18px 18px 1fr 60px 90px 64px 72px 72px 68px 56px 100px;">
                <div></div>
                <div title="Hours risk"></div>
                <div title="Budget risk"></div>
                <div title="Date risk"></div>
                <div>Name</div>
                <div class="text-center">Owner</div>
                <div class="text-center">Phase</div>
                <div class="text-center">%</div>
                <div class="text-center">Due</div>
                <div class="text-right">Hours</div>
                <div class="text-right">Budget</div>
                <div class="text-center">âœ“</div>
                <div></div>
            </div>

            {{-- Task Rows --}}
            <div class="divide-y divide-gray-100" id="taskListContainer">
                @php
                if (!function_exists('renderTaskRow')) {
                    function renderTaskRow($task, $allTasks, $phases, $level = 0) {
                        $indent      = $level * 18;
                        $hasChildren = $allTasks->where('parent_id', $task->id)
                                                ->where('id', '!=', $task->id)
                                                ->count() > 0;

                        $hoursRisk  = taskHoursRiskColor($task->hours_worked, $task->duration, $task->duration_type, $task->percent_complete);
                        $budgetRisk = taskRiskColor($task->actual_budget, $task->target_budget, $task->percent_complete);
                        $dateRisk   = taskDateRiskColor($task->start_date, $task->end_date, $task->percent_complete, $task->is_overdue);
                        $rowBg      = riskRowBg($hoursRisk, $budgetRisk, $dateRisk);

                        $ownerFirst    = $task->owner->first_name ?? '?';
                        $ownerLast     = $task->owner->last_name  ?? '';
                        $ownerInitials = substr($ownerFirst, 0, 1) . substr($ownerLast, 0, 1);
                        $ownerName     = trim($ownerFirst . ' ' . $ownerLast);

                        $phaseName = '';
                        if ($task->phase !== null && isset($phases[$task->phase])) {
                            $parts     = explode('|', $phases[$task->phase]);
                            $phaseName = count($parts) === 2 ? $parts[1] : $phases[$task->phase];
                        }

                        $checkTotal     = $task->checklist->count();
                        $checkCompleted = $task->checklist->filter(fn($c) => !is_null($c->checkedby))->count();

                        $durUnit     = $task->duration_type == 24 ? 'd' : 'h';
                        $durExpected = $task->duration > 0 ? number_format($task->duration, 0) . $durUnit : 'â€”';
                        $durActual   = $task->hours_worked > 0 ? number_format($task->hours_worked, 1) . 'h' : 'â€”';

                        $statusDot = match($task->status) {
                            3       => 'bg-green-500',
                            1       => 'bg-blue-500',
                            2       => 'bg-yellow-500',
                            4       => 'bg-red-400',
                            default => 'bg-gray-300',
                        };

                        $priorityBadge = '';
                        if ($task->priority >= 7) {
                            $priorityBadge = '<span class="ml-1 px-1 py-0.5 text-xs font-bold bg-red-100 text-red-700 rounded">HI</span>';
                        }

                        $milestoneIcon = $task->milestone
                            ? '<svg class="w-3.5 h-3.5 text-blue-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24" title="Milestone"><path d="M5 2a1 1 0 00-1 1v18a1 1 0 001.447.894L12 18.618l6.553 3.276A1 1 0 0020 21V3a1 1 0 00-1-1H5z"/></svg>'
                            : '';

                        $taskId = $task->id;

                        // Sprint / Kanban
                        $isSprint       = (bool)($task->task_sprint ?? false);
                        $parentTask     = $task->parent_id ? $allTasks->firstWhere('id', $task->parent_id) : null;
                        $parentIsSprint = $parentTask && ($parentTask->task_sprint ?? false);

                        // Kanban bolt icon â€” only on sprint tasks
                        $kanbanIcon = $isSprint
                            ? '<button onclick="event.stopPropagation(); openKanbanBoard(' . $taskId . ')"
                                        class="p-1 text-amber-400 hover:text-amber-600 rounded transition-colors flex-shrink-0" title="Open Kanban Board">
                                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M13 2L4.09 12.97A1 1 0 005 14.5h6.5L11 22l8.91-10.97A1 1 0 0019 9.5h-6.5L13 2z"/>
                                </svg>
                               </button>'
                            : '';

                        echo '<div class="task-row ' . $rowBg . ' hover:bg-gray-50 transition-colors cursor-pointer"
                                   data-task-id="' . $taskId . '"
                                   data-level="' . $level . '"
                                   onclick="toggleTaskDetail(' . $taskId . ')">';

                        echo '<div class="px-2 py-1 grid gap-2 items-center text-sm"
                                   style="grid-template-columns: 18px 18px 18px 18px 1fr 60px 90px 64px 72px 72px 68px 56px 100px;
                                          margin-left: ' . $indent . 'px;">';

                        // Col 1: Expand/Collapse or status dot
                        if ($hasChildren) {
                            echo '<button class="task-toggle flex-shrink-0 text-gray-400 hover:text-gray-600"
                                          data-task-id="' . $taskId . '"
                                          onclick="event.stopPropagation(); toggleTaskChildren(' . $taskId . ')"
                                          title="Toggle children">';
                            echo '<svg class="w-3.5 h-3.5 transition-transform rotate-90" id="toggle-icon-' . $taskId . '"
                                       fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                            echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>';
                            echo '</svg></button>';
                        } else {
                            $statusLabel = match($task->status) {
                                3 => 'Complete', 1 => 'In Progress',
                                2 => 'On Hold',  4 => 'Cancelled',
                                default => 'Not Started',
                            };
                            echo '<div class="flex items-center justify-center">';
                            echo '<div class="w-2 h-2 rounded-full ' . $statusDot . '" title="' . $statusLabel . '"></div>';
                            echo '</div>';
                        }

                        // Flag icon â€” inline SVG, shown after task name when flagged
                        $flagIcon = '';
                        if ($task->flagged) {
                            $flagTip  = e($task->flag_tooltip);
                            $flagIcon = '<svg class="w-3.5 h-3.5 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24" title="' . $flagTip . '"><path d="M4 4h11l-1.5 5L15 14H4V4zm0 0v18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';
                        }

                        // â”€â”€ Build tooltip messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Hours tooltip
                        $hTipLine1 = 'Hours: ' . $durActual . ' logged / ' . $durExpected . ' expected';
                        $hTipLine2 = match($hoursRisk) {
                            'red'   => 'âš  Over expected hours',
                            'amber' => $task->hours_worked > 0 && $task->percent_complete <= 0
                                        ? 'âš  Hours logged but no progress set'
                                        : 'âš  Hours ahead of progress',
                            'green' => 'âœ“ Hours on track',
                            default => 'No expected hours set',
                        };

                        // Budget tooltip
                        $bActual   = '$' . number_format($task->actual_budget,  0);
                        $bTarget   = '$' . number_format($task->target_budget,  0);
                        $bTipLine1 = 'Budget: ' . $bActual . ' spent / ' . $bTarget . ' budgeted';
                        $bTipLine2 = match($budgetRisk) {
                            'red'   => 'âš  Over budget',
                            'amber' => $task->actual_budget > 0 && $task->percent_complete <= 0
                                        ? 'âš  Spend logged but no progress set'
                                        : 'âš  Spend ahead of progress',
                            'green' => 'âœ“ Budget on track',
                            default => 'No budget set',
                        };

                        // Date tooltip
                        $dateStart  = $task->start_date ? $task->start_date->format('m/d/y') : 'â€”';
                        $dateEnd    = $task->end_date   ? $task->end_date->format('m/d/y')   : 'â€”';
                        $dTipLine1  = 'Dates: ' . $dateStart . ' â†’ ' . $dateEnd;
                        if ($task->is_overdue) {
                            $daysOver  = $task->end_date ? (int) $task->end_date->diffInDays(now()) : '?';
                            $dTipLine2 = 'âš  OVERDUE by ' . $daysOver . ' day' . ($daysOver == 1 ? '' : 's');
                        } elseif ($dateRisk === 'amber' && $task->start_date && $task->end_date) {
                            $elapsed = (int) $task->start_date->diffInDays(now());
                            $total   = (int) $task->start_date->diffInDays($task->end_date);
                            $dTipLine2 = 'âš  ' . $elapsed . ' of ' . $total . ' days elapsed vs ' . $task->percent_complete . '% complete';
                        } elseif ($dateRisk === 'green') {
                            $dTipLine2 = 'âœ“ Schedule on track';
                        } else {
                            $dTipLine2 = 'No due date set';
                        }

                        // â”€â”€ Tooltip wrapper helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // Renders: relative-positioned div wrapping the icon + absolutely-positioned tooltip bubble
                        // Uses inline CSS for z-index so it floats above the grid
                        $tip = function(string $svgPath, string $colorClass, string $line1, string $line2) {
                            $tipBg = str_contains($line2, 'âš  OVERDUE') || str_contains($line2, 'âš  Over')
                                ? 'bg-red-700' : (str_contains($line2, 'âš ') ? 'bg-amber-600' : 'bg-gray-700');
                            echo '<div class="relative flex items-center justify-center group/tip">';
                            echo '<svg class="w-3.5 h-3.5 ' . $colorClass . ' flex-shrink-0 cursor-default" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                            echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' . $svgPath . '"/>';
                            echo '</svg>';
                            // Tooltip bubble â€” hidden until group hover
                            echo '<div class="pointer-events-none absolute bottom-full left-1/2 -translate-x-1/2 mb-2
                                             opacity-0 group-hover/tip:opacity-100 transition-opacity duration-150
                                             ' . $tipBg . ' text-white text-xs rounded-lg py-1.5 px-2.5 whitespace-nowrap shadow-lg"
                                       style="z-index:9999; min-width:160px;">';
                            echo '<div class="font-medium mb-0.5">' . e($line1) . '</div>';
                            echo '<div class="opacity-90">' . e($line2) . '</div>';
                            // Arrow pointing down
                            echo '<div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent ' . str_replace('bg-', 'border-t-', $tipBg) . '"></div>';
                            echo '</div>';
                            echo '</div>';
                        };

                        // Col 2: Hours risk clock
                        $tip(
                            'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
                            riskColorClass($hoursRisk),
                            $hTipLine1, $hTipLine2
                        );

                        // Col 3: Budget risk
                        $tip(
                            'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z',
                            riskColorClass($budgetRisk),
                            $bTipLine1, $bTipLine2
                        );

                        // Col 4: Date risk
                        $tip(
                            'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z',
                            riskColorClass($dateRisk),
                            $dTipLine1, $dTipLine2
                        );

                        // Col 5: Task name + flag + milestone + kanban + priority badge
                        echo '<div class="min-w-0">';
                        echo '<div class="flex items-center gap-1 truncate">';
                        echo '<span class="font-medium text-gray-900 truncate">' . e($task->name) . '</span>';
                        if ($flagIcon)      echo $flagIcon;
                        if ($milestoneIcon) echo $milestoneIcon;
                        if ($kanbanIcon)    echo $kanbanIcon;
                        echo $priorityBadge;
                        echo '</div>';
                        $line2 = [];
                        if ($task->start_date) $line2[] = $task->start_date->format('m/d');
                        if ($task->end_date)   $line2[] = $task->end_date->format('m/d/y');
                        $dateStr = !empty($line2) ? implode(' â†’ ', $line2) : '';
                        if ($dateStr || $task->target_budget > 0) {
                            echo '<div class="text-xs text-gray-400 mt-0.5 truncate">';
                            if ($dateStr) echo $dateStr;
                            if ($dateStr && $task->target_budget > 0) echo ' Â· ';
                            if ($task->target_budget > 0) echo '$' . number_format($task->target_budget, 0);
                            echo '</div>';
                        }
                        echo '</div>';

                        // Col 6: Owner avatar
                        echo '<div class="flex justify-center">';
                        echo '<span class="w-6 h-6 rounded-full bg-gray-400 flex items-center justify-center text-white text-xs font-bold flex-shrink-0"
                                    title="' . e($ownerName) . '">' . e($ownerInitials) . '</span>';
                        echo '</div>';

                        // Col 7: Phase
                        echo '<div class="text-center">';
                        if ($phaseName) {
                            echo '<span class="px-1.5 py-0.5 text-xs bg-gray-100 text-gray-600 rounded truncate block max-w-full">' . e($phaseName) . '</span>';
                        } else {
                            echo '<span class="text-gray-300">â€”</span>';
                        }
                        echo '</div>';

                        // Col 8: Percent complete
                        echo '<div class="text-center">';
                        $pctColor = $task->percent_complete == 100 ? 'text-green-600' : ($task->percent_complete >= 50 ? 'text-blue-600' : 'text-gray-600');
                        echo '<span class="text-xs font-semibold ' . $pctColor . '">' . $task->percent_complete . '%</span>';
                        echo '</div>';

                        // Col 9: End date
                        echo '<div class="text-center text-xs text-gray-500">';
                        if ($task->end_date) {
                            $overdueCls = $task->is_overdue ? 'text-red-600 font-semibold' : '';
                            echo '<span class="' . $overdueCls . '">' . $task->end_date->format('m/d/y') . '</span>';
                        } else {
                            echo '<span class="text-gray-300">â€”</span>';
                        }
                        echo '</div>';

                        // Col 10: Hours
                        echo '<div class="text-right text-xs">';
                        echo '<span class="' . riskColorClass($hoursRisk) . '">' . $durActual . '</span>';
                        echo '<span class="text-gray-300"> / </span>';
                        echo '<span class="text-gray-500">' . $durExpected . '</span>';
                        echo '</div>';

                        // Col 11: Budget
                        echo '<div class="text-right text-xs">';
                        if ($task->target_budget > 0 || $task->actual_budget > 0) {
                            echo '<span class="' . riskColorClass($budgetRisk) . '">$' . number_format($task->actual_budget, 0) . '</span>';
                            echo '<span class="text-gray-300"> /</span><br>';
                            echo '<span class="text-gray-500">$' . number_format($task->target_budget, 0) . '</span>';
                        } else {
                            echo '<span class="text-gray-300">â€”</span>';
                        }
                        echo '</div>';

                        // Col 12: Checklist badge â€” always show x/y, clickable when items exist
                        echo '<div class="flex justify-center">';
                        if ($checkTotal > 0) {
                            $checkColor = $checkCompleted == $checkTotal
                                ? 'bg-green-100 text-green-700'
                                : ($checkCompleted > 0 ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-500');
                            $tooltipItems = $task->checklist->map(fn($c) =>
                                ($c->checkedby ? 'âœ“ ' : 'â—‹ ') . e($c->checklist)
                            )->implode('&#10;');
                            echo '<span class="px-1.5 py-0.5 text-xs rounded-full cursor-pointer ' . $checkColor . '"
                                       title="' . $tooltipItems . '"
                                       onclick="event.stopPropagation(); openChecklistModal(' . $taskId . ')">'
                                       . $checkCompleted . '/' . $checkTotal . '</span>';
                        } else {
                            echo '<span class="px-1.5 py-0.5 text-xs rounded-full bg-gray-50 text-gray-400 cursor-pointer"
                                       title="No checklist items"
                                       onclick="event.stopPropagation(); openChecklistModal(' . $taskId . ')">0/0</span>';
                        }
                        echo '</div>';

                        // Col 13: Action buttons
                        echo '<div class="flex items-center justify-end gap-0.5" onclick="event.stopPropagation()">';

                        echo '<button onclick="openTaskLogModal(' . $taskId . ')"
                                       class="p-1 text-gray-400 hover:text-amber-600 rounded transition-colors" title="Log time">';
                        echo '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                        echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>';
                        echo '</svg></button>';

                        // Hide "add child" on sprint tasks (cards go on board) and on children of sprint tasks (no grandchildren)
                        if (!$isSprint && !$parentIsSprint) {
                            echo '<button onclick="openCreateChildTaskModal(' . $taskId . ')"
                                           class="p-1 text-gray-400 hover:text-green-600 rounded transition-colors" title="Add child task">';
                            echo '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                            echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>';
                            echo '</svg></button>';
                        }

                        echo '<button onclick="openEditTaskModal(' . $taskId . ')"
                                       class="p-1 text-gray-400 hover:text-blue-600 rounded transition-colors" title="Edit task">';
                        echo '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                        echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>';
                        echo '</svg></button>';

                        echo '<button onclick="confirmDeleteTask(' . $taskId . ')"
                                       class="p-1 text-gray-400 hover:text-red-600 rounded transition-colors" title="Delete task">';
                        echo '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                        echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>';
                        echo '</svg></button>';

                        echo '</div>';
                        echo '</div>'; // end grid
                        echo '</div>'; // end task-row

                        // â”€â”€ Expandable Detail Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        echo '<div id="task-detail-' . $taskId . '" class="task-detail-panel hidden border-t border-gray-100 bg-gray-50"
                                   style="margin-left: ' . ($indent + 18) . 'px;">';
                        echo '<div class="px-6 py-4 flex gap-4 text-sm">';
                        echo '<div class="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4">';

                        if ($task->description) {
                            echo '<div class="col-span-2 md:col-span-4">';
                            echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Description</p>';
                            echo '<p class="text-gray-700 whitespace-pre-line">' . e($task->description) . '</p>';
                            echo '</div>';
                        }

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Start</p>';
                        echo '<p class="text-gray-800">' . ($task->start_date ? $task->start_date->format('M d, Y') : 'â€”') . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Due</p>';
                        $dueCls = $task->is_overdue ? 'text-red-600 font-semibold' : 'text-gray-800';
                        echo '<p class="' . $dueCls . '">' . ($task->end_date ? $task->end_date->format('M d, Y') : 'â€”') . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Expected Hours</p>';
                        echo '<p class="text-gray-800">' . ($task->duration > 0 ? number_format($task->duration, 1) . ($task->duration_type == 24 ? ' days' : ' hrs') : 'â€”') . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Actual Hours</p>';
                        echo '<p class="' . riskColorClass($hoursRisk) . '">' . ($task->hours_worked > 0 ? number_format($task->hours_worked, 1) . ' hrs' : 'â€”') . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Target Budget</p>';
                        echo '<p class="text-gray-800">$' . number_format($task->target_budget, 2) . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Actual Cost</p>';
                        echo '<p class="' . riskColorClass($budgetRisk) . '">$' . number_format($task->actual_budget, 2) . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Status</p>';
                        echo '<p class="text-gray-800">' . $task->status_text . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Priority</p>';
                        echo '<p class="text-gray-800">' . $task->priority_text . ' (' . $task->priority . ')</p>';
                        echo '</div>';

                        if ($task->cost_code) {
                            echo '<div>';
                            echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Cost Code</p>';
                            echo '<p class="text-gray-800">' . e($task->cost_code) . '</p>';
                            echo '</div>';
                        }

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Created</p>';
                        echo '<p class="text-gray-600 text-xs">' . ($task->created_at ? $task->created_at->format('M d, Y') : 'â€”') . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Last Edited</p>';
                        echo '<p class="text-gray-600 text-xs">' . ($task->last_edited ? $task->last_edited->format('M d, Y') : 'â€”') . '</p>';
                        echo '</div>';

                        echo '</div>'; // end data grid

                        // Task Team â€” pinned right column
                        echo '<div class="flex-shrink-0 w-40">';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-2">Task Team</p>';
                        echo '<div class="space-y-1">';
                        $taskTeam       = $task->team ?? collect();
                        $taskAssignedId = $task->task_assigned;
                        if ($taskTeam->isEmpty()) {
                            echo '<span class="text-xs text-gray-400">No members assigned</span>';
                        } else {
                            foreach ($taskTeam as $member) {
                                $mFirst      = $member->user->first_name ?? '';
                                $mLast       = $member->user->last_name  ?? '';
                                $mName       = trim($mFirst . ' ' . $mLast);
                                $isOwner     = (bool)($member->is_owner ?? false);
                                $isAssigned  = $taskAssignedId && $member->user_id == $taskAssignedId;
                                $initials    = strtoupper(substr($mFirst, 0, 1) . substr($mLast, 0, 1));
                                // Amber highlight = currently assigned (working now); owner gets â˜… label only
                                $avatarBg    = $isAssigned ? 'bg-amber-400 text-white' : 'bg-gray-200 text-gray-600';
                                $nameCls     = $isAssigned ? 'font-semibold text-gray-900' : 'text-gray-700';
                                $hours       = $member->hours > 0 ? number_format($member->hours, 1) . 'h' : null;
                                $suffix      = $isOwner ? ' â˜…' : '';
                                echo '<div class="flex items-center gap-1.5 mb-1">';
                                echo '<span class="w-6 h-6 rounded-full ' . $avatarBg . ' flex items-center justify-center text-xs font-bold flex-shrink-0">' . e($initials) . '</span>';
                                echo '<div class="min-w-0">';
                                echo '<div class="text-xs ' . $nameCls . ' truncate">' . e($mName) . $suffix . '</div>';
                                if ($hours) echo '<div class="text-xs text-gray-400">' . $hours . '</div>';
                                echo '</div>';
                                echo '</div>';
                            }
                        }
                        echo '</div>';
                        echo '</div>';

                        echo '</div>'; // end flex
                        echo '</div>'; // end detail panel

                        // â”€â”€ Children â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        if ($hasChildren) {
                            $children = $allTasks->where('parent_id', $task->id)
                                                 ->where('id', '!=', $task->id)
                                                 ->sortBy('task_order');
                            echo '<div class="task-children" id="children-' . $taskId . '">';
                            foreach ($children as $child) {
                                renderTaskRow($child, $allTasks, $phases, $level + 1);
                            }
                            echo '</div>';
                        }
                    }
                }
                @endphp

                @foreach($topLevelTasks as $task)
                    @php renderTaskRow($task, $allTasks, $phases, 0); @endphp
                @endforeach
            </div>

            {{-- Risk Legend --}}
            <div class="px-4 py-2 bg-gray-50 border-t border-gray-100 flex items-center gap-4 text-xs text-gray-500">
                <span class="font-medium text-gray-400 uppercase tracking-wide">Risk:</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span> On track</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span> Consuming ahead of progress</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span> Exceeded / Overdue</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-300 inline-block"></span> No data</span>
            </div>

        @else
            {{-- Empty State --}}
            <div class="text-center py-16">
                <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <h3 class="mt-3 text-sm font-medium text-gray-900">No tasks yet</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by creating the first task.</p>
                <button onclick="document.getElementById('taskCreateModal').classList.remove('hidden')"
                        class="mt-4 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition-colors">
                    + New Task
                </button>
            </div>
        @endif
    </div>{{-- end tab-tasks --}}

    {{-- â”€â”€ OTHER TABS (placeholders) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ --}}
    @foreach(['tab-overdue' => 'Overdue Tasks', 'tab-files' => 'Files', 'tab-forums' => 'Forums', 'tab-gantt' => 'Gantt Chart', 'tab-log' => 'Workflow Log'] as $tabId => $tabLabel)
    <div id="{{ $tabId }}" class="tab-content hidden">
        <div class="text-center py-16 text-gray-400">
            <p class="text-sm font-medium">{{ $tabLabel }}</p>
            <p class="text-xs mt-1">Coming soon</p>
        </div>
    </div>
    @endforeach

</div>{{-- end widget-card --}}


{{-- ============================================================
     TASK LOG SLIDEOUT
     Right-side panel. Collapsible entry form at top,
     full scrollable history list below.
     JS in project-tasks.js: openTaskLogModal(), closeTaskLogModal()
     ============================================================ --}}
<div id="taskLogModal"
     class="fixed inset-0 z-50 hidden"
     role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/40" onclick="closeTaskLogModal()"></div>

    <div class="absolute right-0 top-0 h-full w-full max-w-xl bg-white shadow-2xl flex flex-col">

        {{-- â”€â”€ Header â”€â”€ --}}
        <div class="flex-shrink-0 flex items-start justify-between px-5 py-4 border-b border-gray-200 bg-white">
            <div class="min-w-0 pr-4">
                <h2 class="text-base font-semibold text-gray-900 truncate" id="logModalTaskName">Log Time</h2>
                <div class="flex items-center gap-3 mt-0.5">
                    <span class="text-xs text-gray-400" id="logModalTotalHours"></span>
                    <span id="logModalFlag" class="hidden text-xs text-red-500 flex items-center gap-1">
                        ðŸš© <span id="logModalFlagWho"></span>
                    </span>
                </div>
            </div>
            <button onclick="closeTaskLogModal()"
                    class="flex-shrink-0 p-1.5 text-gray-400 hover:text-gray-600 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        {{-- â”€â”€ Collapsible Entry Form â”€â”€ --}}
        <div class="flex-shrink-0 border-b border-gray-200">
            {{-- Toggle bar â€” starts collapsed --}}
            <button id="logFormToggle"
                    onclick="toggleLogForm()"
                    class="w-full flex items-center justify-between px-5 py-3 bg-amber-50 hover:bg-amber-100 transition-colors text-left">
                <span class="text-sm font-medium text-amber-800">+ New Log Entry</span>
                <svg id="logFormChevron" class="w-4 h-4 text-amber-600 transition-transform"
                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>

            {{-- Form body â€” hidden by default --}}
            <div id="logFormBody" class="hidden px-5 py-4 bg-amber-50/30">

                {{-- Row 1: Hours / Date / Phase / % Complete --}}
                <div class="grid grid-cols-4 gap-2 mb-1">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">
                            Hours <span class="text-red-500">*</span>
                        </label>
                        <input type="text" inputmode="decimal" id="logHours"
                               class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400"
                               placeholder="e.g. 2.5">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">
                            Date <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="logDate"
                               class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Phase</label>
                        <select id="logPhase"
                                class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400 bg-white">
                            <option value="">â€” Phase â€”</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">% Complete</label>
                        <input type="number" id="logPercent" min="0" max="100" step="5"
                               class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400"
                               placeholder="0â€“100">
                    </div>
                </div>
                {{-- Hourly rate / cost estimate line â€” populated by JS --}}
                <div id="logHourlyRateDisplay" class="hidden mb-3 text-xs text-gray-400"></div>

                {{-- Row 2: Summary (flex-grow) + Cost Code (fixed 80px) --}}
                <div class="flex gap-2 mb-3">
                    <div class="flex-1 min-w-0">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Summary</label>
                        <input type="text" id="logName" maxlength="255"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400"
                               placeholder="Brief description of work done">
                    </div>
                    <div style="width:80px;flex-shrink:0;">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Cost Code</label>
                        <input type="text" id="logCostcode" maxlength="8"
                               class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400"
                               placeholder="Code">
                    </div>
                </div>

                {{-- Row 3: Notes --}}
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Notes</label>
                    <textarea id="logDescription" rows="2"
                              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400 resize-none"
                              placeholder="Optional detail"></textarea>
                </div>

                {{-- Row 4: Assigned User â€” 2-column radio grid, populated by JS --}}
                <div id="logAssignedSection" class="hidden mb-3">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Currently Working On This Task</label>
                    <div id="logAssignedList"
                         class="border border-gray-200 rounded-lg bg-white grid grid-cols-2">
                        {{-- Populated by JS: two radio items per row --}}
                    </div>
                </div>

                {{-- Inline confirm banner â€” shown by JS instead of browser confirm() --}}
                <div id="logConfirmBanner" class="hidden mb-3 rounded-lg border border-amber-300 bg-amber-50 px-4 py-3">
                    <p id="logConfirmMessage" class="text-sm font-medium text-amber-900 mb-2"></p>
                    <div class="flex gap-2">
                        <button id="logConfirmYes"
                                class="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white text-xs font-semibold rounded-lg transition-colors">
                            Yes, save anyway
                        </button>
                        <button id="logConfirmNo"
                                class="px-3 py-1.5 bg-white hover:bg-gray-50 text-gray-700 text-xs font-semibold rounded-lg border border-gray-300 transition-colors">
                            Go back
                        </button>
                    </div>
                </div>

                {{-- Row 5: Red flag + Save on same line --}}
                <div class="flex items-center gap-3">
                    <label class="flex flex-1 items-center gap-2 p-2.5 rounded-lg border border-gray-200 bg-white cursor-pointer hover:bg-red-50 transition-colors">
                        <input type="checkbox" id="logRiskFlag"
                               class="w-4 h-4 rounded border-gray-300 text-red-500 focus:ring-red-400">
                        <span class="text-base leading-none">ðŸš©</span>
                        <span class="text-sm font-medium text-gray-700">Raise a red flag</span>
                        <span class="text-xs text-gray-400 ml-auto hidden sm:inline">alerts team</span>
                    </label>
                    <button onclick="submitTaskLog()"
                            class="flex-shrink-0 px-4 py-2.5 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition-colors whitespace-nowrap">
                        Save Log Entry
                    </button>
                    <span id="logSaveStatus" class="text-xs flex-shrink-0"></span>
                </div>

            </div>
        </div>

        {{-- â”€â”€ Log History (scrollable) â”€â”€ --}}
        <div class="flex-1 overflow-y-auto">
            <div class="px-5 py-3 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">History</span>
                <div class="flex items-center gap-4">
                    {{-- Total cost â€” shown to project owners only, populated by JS --}}
                    <span id="logTotalCost" class="hidden text-xs font-semibold text-gray-600"></span>
                    <span id="logEntryCount" class="text-xs text-gray-400"></span>
                </div>
            </div>
            <div id="logHistoryList" class="divide-y divide-gray-100">
                <div class="px-5 py-8 text-center text-xs text-gray-400">Loadingâ€¦</div>
            </div>
        </div>

    </div>
</div>


{{-- ============================================================
     CHECKLIST SLIDEOUT
     Right-side panel. Permission-aware:
     - Task owner / project owner: create, edit text, check, UNCHECK
     - All others: view + check only (cannot uncheck)
     JS in project-tasks.js: openChecklistModal(), closeChecklistModal()
     ============================================================ --}}
<div id="taskChecklistModal"
     class="fixed inset-0 z-50 hidden"
     role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/40" onclick="closeChecklistModal()"></div>

    <div class="absolute right-0 top-0 h-full w-full max-w-lg bg-white shadow-2xl flex flex-col">

        {{-- â”€â”€ Header â”€â”€ --}}
        <div class="flex-shrink-0 flex items-center justify-between px-5 py-4 border-b border-gray-200">
            <div>
                <h2 class="text-base font-semibold text-gray-900" id="checklistModalTaskName">Checklist</h2>
                <p class="text-xs text-gray-400 mt-0.5" id="checklistModalProgress"></p>
            </div>
            <button onclick="closeChecklistModal()"
                    class="p-1.5 text-gray-400 hover:text-gray-600 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        {{-- â”€â”€ Add Item (owners only â€” shown/hidden by JS based on canManage flag) â”€â”€ --}}
        <div id="checklistAddRow" class="hidden flex-shrink-0 px-5 py-3 border-b border-gray-100 bg-gray-50">
            <div class="flex gap-2">
                <input type="text" id="checklistNewItem" maxlength="255"
                       placeholder="New checklist itemâ€¦"
                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400"
                       onkeydown="if(event.key==='Enter'){ event.preventDefault(); addChecklistItem(); }">
                <button onclick="addChecklistItem()"
                        class="px-3 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition-colors whitespace-nowrap">
                    Add
                </button>
            </div>
            <p id="checklistAddStatus" class="text-xs mt-1 text-gray-400 hidden"></p>
        </div>

        {{-- â”€â”€ Items List (scrollable) â”€â”€ --}}
        <div class="flex-1 overflow-y-auto">
            <div id="checklistItems" class="divide-y divide-gray-100">
                <div class="px-5 py-8 text-center text-xs text-gray-400">Loadingâ€¦</div>
            </div>
        </div>

        {{-- â”€â”€ Footer: save order / status â”€â”€ --}}
        <div id="checklistFooter" class="hidden flex-shrink-0 px-5 py-3 border-t border-gray-100 bg-gray-50 flex items-center justify-between">
            <span id="checklistFooterStatus" class="text-xs text-gray-400"></span>
        </div>

    </div>
</div>


{{-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     KANBAN BOARD MODAL
     Full-screen overlay showing sprint task children as sticky note cards.
     Columns: Backlog | Phase 1 | Phase 2 | â€¦ | Stuck
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• --}}
<div id="kanbanBoardModal"
     class="fixed inset-0 bg-gray-900 bg-opacity-95 z-[60] hidden flex flex-col"
     style="backdrop-filter: blur(4px);">

    {{-- Board Header --}}
    <div class="flex-shrink-0 bg-gray-900 border-b border-gray-700 px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <svg class="w-5 h-5 text-amber-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                <path d="M13 2L4.09 12.97A1 1 0 005 14.5h6.5L11 22l8.91-10.97A1 1 0 0019 9.5h-6.5L13 2z"/>
            </svg>
            <div>
                <h2 id="kanbanBoardTitle" class="text-lg font-bold text-white leading-tight">Sprint Board</h2>
                <div id="kanbanBoardMeta" class="flex items-center gap-4 text-xs text-gray-400 mt-0.5"></div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="addKanbanCard()"
                    class="flex items-center gap-1.5 px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white text-xs font-medium rounded-lg transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Add Card
            </button>
            <button onclick="closeKanbanBoard()"
                    class="p-2 text-gray-400 hover:text-white rounded-lg transition-colors" title="Close">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    {{-- Board Columns (horizontal scroll) --}}
    <div class="flex-1 overflow-x-auto overflow-y-hidden">
        <div id="kanbanColumnsContainer" class="flex gap-4 p-5 h-full min-w-max items-start">
            {{-- Columns injected by JS --}}
        </div>
    </div>

</div>
