{{-- ============================================================
     PROJECT SHOW â€” MAIN TASK PANEL
     Tab strip + task rows + risk legend
     ============================================================ --}}

{{-- â”€â”€ TASK RISK CALCULATION FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ --}}
@php
if (!defined('TASK_RISK_RATIO')) define('TASK_RISK_RATIO', 1.10);

if (!function_exists('taskRiskColor')) {
    function taskRiskColor($actual, $total, $progress): string {
        if (!$total || $total <= 0) return 'grey';
        if ($actual === null || $actual < 0) return 'grey';
        $consumedRatio = $actual / $total;
        $progressRatio = ($progress > 0) ? ($progress / 100) : 0;
        if ($consumedRatio >= 1.0) return 'red';
        if ($progressRatio <= 0 && $consumedRatio > 0) return 'amber';
        if ($consumedRatio > ($progressRatio * TASK_RISK_RATIO)) return 'amber';
        return 'green';
    }
}

if (!function_exists('taskDateRiskColor')) {
    function taskDateRiskColor($startDate, $endDate, $progress, $isOverdue): string {
        if ($isOverdue) return 'red';
        if (!$startDate || !$endDate) return 'grey';
        $totalDays   = $startDate->diffInDays($endDate);
        if ($totalDays <= 0) return 'grey';
        $elapsedDays = $startDate->diffInDays(now(), false);
        if ($elapsedDays <= 0) return 'green';
        return taskRiskColor($elapsedDays, $totalDays, $progress);
    }
}

if (!function_exists('taskHoursRiskColor')) {
    function taskHoursRiskColor($hoursWorked, $duration, $durationType, $progress): string {
        if (!$duration || $duration <= 0) return 'grey';
        if ($hoursWorked === null) return 'grey';
        $expectedHours = ($durationType == 24) ? ($duration * 8) : $duration;
        return taskRiskColor($hoursWorked, $expectedHours, $progress);
    }
}

if (!function_exists('riskColorClass')) {
    function riskColorClass(string $color): string {
        return match($color) {
            'green' => 'text-green-500',
            'amber' => 'text-amber-500',
            'red'   => 'text-red-500',
            default => 'text-gray-300',
        };
    }
}

if (!function_exists('riskRowBg')) {
    function riskRowBg(string $hours, string $budget, string $date): string {
        $colors = [$hours, $budget, $date];
        if (in_array('red', $colors))   return 'bg-red-50';
        if (in_array('amber', $colors)) return 'bg-amber-50';
        return '';
    }
}

$allTasks      = $project->tasks;
$topLevelTasks = $allTasks->filter(fn($task) => is_null($task->parent_id) || $task->parent_id == $task->id)
                          ->sortBy('task_order');
$phases        = $project->phases ?? [];
@endphp

<div class="widget-card" id="taskListCard">

    {{-- Tab Strip --}}
    <div class="border-b border-gray-200 px-4 flex items-center justify-between">
        <div class="flex items-center gap-0 overflow-x-auto" id="projectTabStrip">
            <button onclick="switchProjectTab('tab-tasks')"
                    class="project-tab active px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-amber-500 text-amber-700 bg-white -mb-px"
                    data-tab="tab-tasks">
                Tasks
                <span class="ml-1 px-1.5 py-0.5 text-xs bg-gray-100 text-gray-600 rounded-full">{{ $stats['total_tasks'] }}</span>
            </button>
            <button onclick="switchProjectTab('tab-overdue')"
                    class="project-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 -mb-px"
                    data-tab="tab-overdue">
                Overdue
                @if($stats['overdue_tasks'] > 0)
                    <span class="ml-1 px-1.5 py-0.5 text-xs bg-red-100 text-red-600 rounded-full">{{ $stats['overdue_tasks'] }}</span>
                @endif
            </button>
            <button onclick="switchProjectTab('tab-files')"
                    class="project-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 -mb-px"
                    data-tab="tab-files">Files</button>
            <button onclick="switchProjectTab('tab-forums')"
                    class="project-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 -mb-px"
                    data-tab="tab-forums">Forums</button>
            <button onclick="switchProjectTab('tab-gantt')"
                    class="project-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 -mb-px"
                    data-tab="tab-gantt">Gantt</button>
            <button onclick="switchProjectTab('tab-log')"
                    class="project-tab px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 -mb-px"
                    data-tab="tab-log">Workflow Log</button>
        </div>
        <button id="openTaskModal"
                class="flex-shrink-0 ml-4 flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-white bg-amber-500 hover:bg-amber-600 rounded-lg transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Add Task
        </button>
    </div>

    {{-- â”€â”€ TAB: TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ --}}
    <div id="tab-tasks" class="tab-content">

        @if($allTasks->count() > 0)

            {{-- Sticky Column Headers --}}
            <div class="sticky top-0 z-10 bg-gray-50 border-b border-gray-200 px-2 py-1.5 grid gap-2 text-xs font-medium text-gray-400 uppercase tracking-wide"
                 style="grid-template-columns: 18px 18px 18px 18px 1fr 60px 90px 64px 72px 72px 68px 56px 100px;">
                <div></div>
                <div title="Hours risk"></div>
                <div title="Budget risk"></div>
                <div title="Date risk"></div>
                <div>Name</div>
                <div class="text-center">Owner</div>
                <div class="text-center">Phase</div>
                <div class="text-center">%</div>
                <div class="text-center">Due</div>
                <div class="text-right">Hours</div>
                <div class="text-right">Budget</div>
                <div class="text-center">âœ“</div>
                <div></div>
            </div>

            {{-- Task Rows --}}
            <div class="divide-y divide-gray-100" id="taskListContainer">
                @php
                if (!function_exists('renderTaskRow')) {
                    function renderTaskRow($task, $allTasks, $phases, $level = 0) {
                        $indent      = $level * 18;
                        $hasChildren = $allTasks->where('parent_id', $task->id)
                                                ->where('id', '!=', $task->id)
                                                ->count() > 0;

                        $hoursRisk  = taskHoursRiskColor($task->hours_worked, $task->duration, $task->duration_type, $task->percent_complete);
                        $budgetRisk = taskRiskColor($task->actual_budget, $task->target_budget, $task->percent_complete);
                        $dateRisk   = taskDateRiskColor($task->start_date, $task->end_date, $task->percent_complete, $task->is_overdue);
                        $rowBg      = riskRowBg($hoursRisk, $budgetRisk, $dateRisk);

                        $ownerFirst    = $task->owner->first_name ?? '?';
                        $ownerLast     = $task->owner->last_name  ?? '';
                        $ownerInitials = substr($ownerFirst, 0, 1) . substr($ownerLast, 0, 1);
                        $ownerName     = trim($ownerFirst . ' ' . $ownerLast);

                        $phaseName = '';
                        if ($task->phase !== null && isset($phases[$task->phase])) {
                            $parts     = explode('|', $phases[$task->phase]);
                            $phaseName = count($parts) === 2 ? $parts[1] : $phases[$task->phase];
                        }

                        $checkTotal     = $task->checklist->count();
                        $checkCompleted = $task->checklist->filter(fn($c) => !is_null($c->checkedby))->count();

                        $durUnit     = $task->duration_type == 24 ? 'd' : 'h';
                        $durExpected = $task->duration > 0 ? number_format($task->duration, 0) . $durUnit : 'â€”';
                        $durActual   = $task->hours_worked > 0 ? number_format($task->hours_worked, 1) . 'h' : 'â€”';

                        $statusDot = match($task->status) {
                            3       => 'bg-green-500',
                            1       => 'bg-blue-500',
                            2       => 'bg-yellow-500',
                            4       => 'bg-red-400',
                            default => 'bg-gray-300',
                        };

                        $priorityBadge = '';
                        if ($task->priority >= 7) {
                            $priorityBadge = '<span class="ml-1 px-1 py-0.5 text-xs font-bold bg-red-100 text-red-700 rounded">HI</span>';
                        }

                        $milestoneIcon = $task->milestone
                            ? '<svg class="w-3 h-3 text-amber-500 inline mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'
                            : '';

                        $taskId = $task->id;

                        echo '<div class="task-row ' . $rowBg . ' hover:bg-gray-50 transition-colors cursor-pointer"
                                   data-task-id="' . $taskId . '"
                                   data-level="' . $level . '"
                                   onclick="toggleTaskDetail(' . $taskId . ')">';

                        echo '<div class="px-2 py-1 grid gap-2 items-center text-sm"
                                   style="grid-template-columns: 18px 18px 18px 18px 1fr 60px 90px 64px 72px 72px 68px 56px 100px;
                                          margin-left: ' . $indent . 'px;">';

                        // Col 1: Expand/Collapse or status dot
                        if ($hasChildren) {
                            echo '<button class="task-toggle flex-shrink-0 text-gray-400 hover:text-gray-600"
                                          data-task-id="' . $taskId . '"
                                          onclick="event.stopPropagation(); toggleTaskChildren(' . $taskId . ')"
                                          title="Toggle children">';
                            echo '<svg class="w-3.5 h-3.5 transition-transform rotate-90" id="toggle-icon-' . $taskId . '"
                                       fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                            echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>';
                            echo '</svg></button>';
                        } else {
                            $statusLabel = match($task->status) {
                                3 => 'Complete', 1 => 'In Progress',
                                2 => 'On Hold',  4 => 'Cancelled',
                                default => 'Not Started',
                            };
                            echo '<div class="flex items-center justify-center">';
                            echo '<div class="w-2 h-2 rounded-full ' . $statusDot . '" title="' . $statusLabel . '"></div>';
                            echo '</div>';
                        }

                        // Flag icon â€” shown when task.flagged = true
                        // Sits in Col 2 slot (hours risk), replacing the clock icon when flagged
                        $flagHtml = '';
                        if ($task->flagged) {
                            $flagTip = e($task->flag_tooltip);
                            $flagHtml = '<span class="flex-shrink-0 text-red-500 leading-none" title="' . $flagTip . '" style="font-size:13px;">ðŸš©</span>';
                        }

                        // Col 2: Flag (if raised) OR hours risk clock
                        if ($task->flagged) {
                            echo $flagHtml;
                        } else {
                            $hClass = riskColorClass($hoursRisk);
                            echo '<svg class="w-3.5 h-3.5 ' . $hClass . ' flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Hours: ' . $durActual . ' / ' . $durExpected . '">';
                            echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>';
                            echo '</svg>';
                        }

                        // Col 3: Budget risk
                        $bClass = riskColorClass($budgetRisk);
                        echo '<svg class="w-3.5 h-3.5 ' . $bClass . ' flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Budget: $' . number_format($task->actual_budget, 0) . ' / $' . number_format($task->target_budget, 0) . '">';
                        echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>';
                        echo '</svg>';

                        // Col 4: Date risk
                        $dClass = riskColorClass($dateRisk);
                        echo '<svg class="w-3.5 h-3.5 ' . $dClass . ' flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Date: ' . ($task->start_date ? $task->start_date->format('m/d') : 'â€”') . ' â†’ ' . ($task->end_date ? $task->end_date->format('m/d/y') : 'â€”') . '">';
                        echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>';
                        echo '</svg>';

                        // Col 5: Task name
                        echo '<div class="min-w-0">';
                        echo '<div class="flex items-center gap-1 truncate">';
                        echo $milestoneIcon;
                        echo '<span class="font-medium text-gray-900 truncate">' . e($task->name) . '</span>';
                        echo $priorityBadge;
                        echo '</div>';
                        $line2 = [];
                        if ($task->start_date) $line2[] = $task->start_date->format('m/d');
                        if ($task->end_date)   $line2[] = $task->end_date->format('m/d/y');
                        $dateStr = !empty($line2) ? implode(' â†’ ', $line2) : '';
                        if ($dateStr || $task->target_budget > 0) {
                            echo '<div class="text-xs text-gray-400 mt-0.5 truncate">';
                            if ($dateStr) echo $dateStr;
                            if ($dateStr && $task->target_budget > 0) echo ' Â· ';
                            if ($task->target_budget > 0) echo '$' . number_format($task->target_budget, 0);
                            echo '</div>';
                        }
                        echo '</div>';

                        // Col 6: Owner avatar
                        echo '<div class="flex justify-center">';
                        echo '<span class="w-6 h-6 rounded-full bg-gray-400 flex items-center justify-center text-white text-xs font-bold flex-shrink-0"
                                    title="' . e($ownerName) . '">' . e($ownerInitials) . '</span>';
                        echo '</div>';

                        // Col 7: Phase
                        echo '<div class="text-center">';
                        if ($phaseName) {
                            echo '<span class="px-1.5 py-0.5 text-xs bg-gray-100 text-gray-600 rounded truncate block max-w-full">' . e($phaseName) . '</span>';
                        } else {
                            echo '<span class="text-gray-300">â€”</span>';
                        }
                        echo '</div>';

                        // Col 8: Percent complete
                        echo '<div class="text-center">';
                        $pctColor = $task->percent_complete == 100 ? 'text-green-600' : ($task->percent_complete >= 50 ? 'text-blue-600' : 'text-gray-600');
                        echo '<span class="text-xs font-semibold ' . $pctColor . '">' . $task->percent_complete . '%</span>';
                        echo '</div>';

                        // Col 9: End date
                        echo '<div class="text-center text-xs text-gray-500">';
                        if ($task->end_date) {
                            $overdueCls = $task->is_overdue ? 'text-red-600 font-semibold' : '';
                            echo '<span class="' . $overdueCls . '">' . $task->end_date->format('m/d/y') . '</span>';
                        } else {
                            echo '<span class="text-gray-300">â€”</span>';
                        }
                        echo '</div>';

                        // Col 10: Hours
                        echo '<div class="text-right text-xs">';
                        echo '<span class="' . riskColorClass($hoursRisk) . '">' . $durActual . '</span>';
                        echo '<span class="text-gray-300"> / </span>';
                        echo '<span class="text-gray-500">' . $durExpected . '</span>';
                        echo '</div>';

                        // Col 11: Budget
                        echo '<div class="text-right text-xs">';
                        if ($task->target_budget > 0 || $task->actual_budget > 0) {
                            echo '<span class="' . riskColorClass($budgetRisk) . '">$' . number_format($task->actual_budget, 0) . '</span>';
                            echo '<span class="text-gray-300"> /</span><br>';
                            echo '<span class="text-gray-500">$' . number_format($task->target_budget, 0) . '</span>';
                        } else {
                            echo '<span class="text-gray-300">â€”</span>';
                        }
                        echo '</div>';

                        // Col 12: Checklist badge â€” always show x/y, clickable when items exist
                        echo '<div class="flex justify-center">';
                        if ($checkTotal > 0) {
                            $checkColor = $checkCompleted == $checkTotal
                                ? 'bg-green-100 text-green-700'
                                : ($checkCompleted > 0 ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-500');
                            $tooltipItems = $task->checklist->map(fn($c) =>
                                ($c->checkedby ? 'âœ“ ' : 'â—‹ ') . e($c->checklist)
                            )->implode('&#10;');
                            echo '<span class="px-1.5 py-0.5 text-xs rounded-full cursor-pointer ' . $checkColor . '"
                                       title="' . $tooltipItems . '"
                                       onclick="event.stopPropagation(); openChecklistModal(' . $taskId . ')">'
                                       . $checkCompleted . '/' . $checkTotal . '</span>';
                        } else {
                            echo '<span class="px-1.5 py-0.5 text-xs rounded-full bg-gray-50 text-gray-400 cursor-pointer"
                                       title="No checklist items"
                                       onclick="event.stopPropagation(); openChecklistModal(' . $taskId . ')">0/0</span>';
                        }
                        echo '</div>';

                        // Col 13: Action buttons
                        echo '<div class="flex items-center justify-end gap-0.5" onclick="event.stopPropagation()">';

                        echo '<button onclick="openTaskLogModal(' . $taskId . ')"
                                       class="p-1 text-gray-400 hover:text-amber-600 rounded transition-colors" title="Log time">';
                        echo '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                        echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>';
                        echo '</svg></button>';

                        echo '<button onclick="openCreateChildTaskModal(' . $taskId . ')"
                                       class="p-1 text-gray-400 hover:text-green-600 rounded transition-colors" title="Add child task">';
                        echo '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                        echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>';
                        echo '</svg></button>';

                        echo '<button onclick="openEditTaskModal(' . $taskId . ')"
                                       class="p-1 text-gray-400 hover:text-blue-600 rounded transition-colors" title="Edit task">';
                        echo '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                        echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>';
                        echo '</svg></button>';

                        echo '<button onclick="confirmDeleteTask(' . $taskId . ')"
                                       class="p-1 text-gray-400 hover:text-red-600 rounded transition-colors" title="Delete task">';
                        echo '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                        echo '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>';
                        echo '</svg></button>';

                        echo '</div>';
                        echo '</div>'; // end grid
                        echo '</div>'; // end task-row

                        // â”€â”€ Expandable Detail Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        echo '<div id="task-detail-' . $taskId . '" class="task-detail-panel hidden border-t border-gray-100 bg-gray-50"
                                   style="margin-left: ' . ($indent + 18) . 'px;">';
                        echo '<div class="px-6 py-4 flex gap-4 text-sm">';
                        echo '<div class="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4">';

                        if ($task->description) {
                            echo '<div class="col-span-2 md:col-span-4">';
                            echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Description</p>';
                            echo '<p class="text-gray-700 whitespace-pre-line">' . e($task->description) . '</p>';
                            echo '</div>';
                        }

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Start</p>';
                        echo '<p class="text-gray-800">' . ($task->start_date ? $task->start_date->format('M d, Y') : 'â€”') . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Due</p>';
                        $dueCls = $task->is_overdue ? 'text-red-600 font-semibold' : 'text-gray-800';
                        echo '<p class="' . $dueCls . '">' . ($task->end_date ? $task->end_date->format('M d, Y') : 'â€”') . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Expected Hours</p>';
                        echo '<p class="text-gray-800">' . ($task->duration > 0 ? number_format($task->duration, 1) . ($task->duration_type == 24 ? ' days' : ' hrs') : 'â€”') . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Actual Hours</p>';
                        echo '<p class="' . riskColorClass($hoursRisk) . '">' . ($task->hours_worked > 0 ? number_format($task->hours_worked, 1) . ' hrs' : 'â€”') . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Target Budget</p>';
                        echo '<p class="text-gray-800">$' . number_format($task->target_budget, 2) . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Actual Cost</p>';
                        echo '<p class="' . riskColorClass($budgetRisk) . '">$' . number_format($task->actual_budget, 2) . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Status</p>';
                        echo '<p class="text-gray-800">' . $task->status_text . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Priority</p>';
                        echo '<p class="text-gray-800">' . $task->priority_text . ' (' . $task->priority . ')</p>';
                        echo '</div>';

                        if ($task->cost_code) {
                            echo '<div>';
                            echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Cost Code</p>';
                            echo '<p class="text-gray-800">' . e($task->cost_code) . '</p>';
                            echo '</div>';
                        }

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Created</p>';
                        echo '<p class="text-gray-600 text-xs">' . ($task->created_at ? $task->created_at->format('M d, Y') : 'â€”') . '</p>';
                        echo '</div>';

                        echo '<div>';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Last Edited</p>';
                        echo '<p class="text-gray-600 text-xs">' . ($task->last_edited ? $task->last_edited->format('M d, Y') : 'â€”') . '</p>';
                        echo '</div>';

                        echo '</div>'; // end data grid

                        // Task Team â€” pinned right column
                        echo '<div class="flex-shrink-0 w-40">';
                        echo '<p class="text-xs text-gray-400 uppercase tracking-wide mb-2">Task Team</p>';
                        echo '<div class="space-y-1">';
                        $taskTeam = $task->team ?? collect();
                        if ($taskTeam->isEmpty()) {
                            echo '<span class="text-xs text-gray-400">No members assigned</span>';
                        } else {
                            foreach ($taskTeam as $member) {
                                $mFirst   = $member->user->first_name ?? '';
                                $mLast    = $member->user->last_name  ?? '';
                                $mName    = trim($mFirst . ' ' . $mLast);
                                $isOwner  = (bool)($member->is_owner ?? false);
                                $nameCls  = $isOwner ? 'font-semibold text-gray-900' : 'text-gray-700';
                                $initials = strtoupper(substr($mFirst, 0, 1) . substr($mLast, 0, 1));
                                $avatarBg = $isOwner ? 'bg-amber-400 text-white' : 'bg-gray-200 text-gray-600';
                                $hours    = $member->hours > 0 ? number_format($member->hours, 1) . 'h' : null;
                                echo '<div class="flex items-center gap-1.5 mb-1">';
                                echo '<span class="w-6 h-6 rounded-full ' . $avatarBg . ' flex items-center justify-center text-xs font-bold flex-shrink-0">' . e($initials) . '</span>';
                                echo '<div class="min-w-0">';
                                echo '<div class="text-xs ' . $nameCls . ' truncate">' . e($mName) . ($isOwner ? ' â˜…' : '') . '</div>';
                                if ($hours) echo '<div class="text-xs text-gray-400">' . $hours . '</div>';
                                echo '</div>';
                                echo '</div>';
                            }
                        }
                        echo '</div>';
                        echo '</div>';

                        echo '</div>'; // end flex
                        echo '</div>'; // end detail panel

                        // â”€â”€ Children â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        if ($hasChildren) {
                            $children = $allTasks->where('parent_id', $task->id)
                                                 ->where('id', '!=', $task->id)
                                                 ->sortBy('task_order');
                            echo '<div class="task-children" id="children-' . $taskId . '">';
                            foreach ($children as $child) {
                                renderTaskRow($child, $allTasks, $phases, $level + 1);
                            }
                            echo '</div>';
                        }
                    }
                }
                @endphp

                @foreach($topLevelTasks as $task)
                    @php renderTaskRow($task, $allTasks, $phases, 0); @endphp
                @endforeach
            </div>

            {{-- Risk Legend --}}
            <div class="px-4 py-2 bg-gray-50 border-t border-gray-100 flex items-center gap-4 text-xs text-gray-500">
                <span class="font-medium text-gray-400 uppercase tracking-wide">Risk:</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span> On track</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span> Consuming ahead of progress</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span> Exceeded / Overdue</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-300 inline-block"></span> No data</span>
            </div>

        @else
            {{-- Empty State --}}
            <div class="text-center py-16">
                <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <h3 class="mt-3 text-sm font-medium text-gray-900">No tasks yet</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by creating the first task.</p>
                <button onclick="document.getElementById('taskCreateModal').classList.remove('hidden')"
                        class="mt-4 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition-colors">
                    + New Task
                </button>
            </div>
        @endif
    </div>{{-- end tab-tasks --}}

    {{-- â”€â”€ OTHER TABS (placeholders) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ --}}
    @foreach(['tab-overdue' => 'Overdue Tasks', 'tab-files' => 'Files', 'tab-forums' => 'Forums', 'tab-gantt' => 'Gantt Chart', 'tab-log' => 'Workflow Log'] as $tabId => $tabLabel)
    <div id="{{ $tabId }}" class="tab-content hidden">
        <div class="text-center py-16 text-gray-400">
            <p class="text-sm font-medium">{{ $tabLabel }}</p>
            <p class="text-xs mt-1">Coming soon</p>
        </div>
    </div>
    @endforeach

</div>{{-- end widget-card --}}

{{-- ============================================================
     TASK LOG MODAL
     Opens when user clicks the clock/log icon on any task row.
     Loads existing logs via GET /tasks/{task}/logs
     Submits new log via POST /tasks/{task}/log-time
     ============================================================ --}}
<div id="taskLogModal"
     class="fixed inset-0 z-50 hidden"
     role="dialog" aria-modal="true">

    {{-- Backdrop --}}
    <div class="absolute inset-0 bg-black/40"
         onclick="closeTaskLogModal()"></div>

    {{-- Panel --}}
    <div class="absolute right-0 top-0 h-full w-full max-w-lg bg-white shadow-xl flex flex-col">

        {{-- Header --}}
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 flex-shrink-0">
            <div>
                <h2 class="text-base font-semibold text-gray-900" id="logModalTaskName">Log Time</h2>
                <p class="text-xs text-gray-400 mt-0.5" id="logModalTaskSummary"></p>
            </div>
            <button onclick="closeTaskLogModal()"
                    class="p-1.5 text-gray-400 hover:text-gray-600 rounded transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        {{-- Scrollable body --}}
        <div class="flex-1 overflow-y-auto">

            {{-- New log entry form --}}
            <div class="px-5 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-sm font-medium text-gray-700 mb-3">New Entry</h3>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    {{-- Hours --}}
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Hours <span class="text-red-500">*</span></label>
                        <input type="number" id="logHours" min="0.01" max="999" step="0.25"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400"
                               placeholder="e.g. 2.5">
                    </div>
                    {{-- Date --}}
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Date <span class="text-red-500">*</span></label>
                        <input type="date" id="logDate"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    {{-- Percent complete --}}
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">% Complete</label>
                        <input type="number" id="logPercent" min="0" max="100" step="5"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400"
                               placeholder="0â€“100">
                    </div>
                    {{-- Cost code --}}
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Cost Code</label>
                        <input type="text" id="logCostcode" maxlength="8"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400"
                               placeholder="Optional">
                    </div>
                </div>

                {{-- Log name --}}
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Summary</label>
                    <input type="text" id="logName" maxlength="255"
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400"
                           placeholder="Brief description of work done">
                </div>

                {{-- Description --}}
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Notes</label>
                    <textarea id="logDescription" rows="2"
                              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400 resize-none"
                              placeholder="Optional detail"></textarea>
                </div>

                {{-- Red flag toggle --}}
                <div class="flex items-center gap-2 mb-4 p-3 rounded-lg border border-gray-200 bg-white">
                    <input type="checkbox" id="logRiskFlag"
                           class="w-4 h-4 rounded border-gray-300 text-red-500 focus:ring-red-400 cursor-pointer">
                    <label for="logRiskFlag" class="flex items-center gap-1.5 text-sm text-gray-700 cursor-pointer select-none">
                        <span class="text-base leading-none">ðŸš©</span>
                        <span class="font-medium">Raise a red flag</span>
                        <span class="text-xs text-gray-400">â€” alerts team this task needs attention</span>
                    </label>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="submitTaskLog()"
                            class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition-colors">
                        Save Log
                    </button>
                    <span id="logSaveStatus" class="text-xs text-gray-400"></span>
                </div>
            </div>

            {{-- Existing log entries --}}
            <div class="px-5 py-4">
                <h3 class="text-sm font-medium text-gray-700 mb-3">Log History
                    <span id="logTotalHours" class="ml-2 text-xs font-normal text-gray-400"></span>
                </h3>
                <div id="logHistoryList" class="space-y-2">
                    <p class="text-xs text-gray-400">Loading...</p>
                </div>
            </div>

        </div>{{-- end scrollable body --}}
    </div>{{-- end panel --}}
</div>{{-- end modal --}}

<script>
// â”€â”€ Task Log Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _logCurrentTaskId = null;

function openTaskLogModal(taskId) {
    _logCurrentTaskId = taskId;

    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('logDate').value = today;

    // Clear form
    ['logHours','logPercent','logCostcode','logName','logDescription'].forEach(id => {
        document.getElementById(id).value = '';
    });
    document.getElementById('logSaveStatus').textContent = '';

    // Show modal
    document.getElementById('taskLogModal').classList.remove('hidden');

    // Load task info + existing logs
    loadTaskLogData(taskId);
}

function closeTaskLogModal() {
    document.getElementById('taskLogModal').classList.add('hidden');
    _logCurrentTaskId = null;
}

function loadTaskLogData(taskId) {
    document.getElementById('logHistoryList').innerHTML = '<p class="text-xs text-gray-400">Loading...</p>';
    document.getElementById('logModalTaskName').textContent = 'Log Time';
    document.getElementById('logModalTaskSummary').textContent = '';

    fetch(`/tasks/${taskId}/logs`, {
        headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) return;

        // Update header with task name if available
        if (data.task_name) {
            document.getElementById('logModalTaskName').textContent = 'Log Time â€” ' + data.task_name;
        }

        renderLogHistory(data.logs);
    })
    .catch(() => {
        document.getElementById('logHistoryList').innerHTML =
            '<p class="text-xs text-red-400">Failed to load logs.</p>';
    });
}

function renderLogHistory(logs) {
    const container = document.getElementById('logHistoryList');
    const totalEl   = document.getElementById('logTotalHours');

    if (!logs || logs.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-400">No time logged yet.</p>';
        totalEl.textContent = '';
        return;
    }

    const totalHours = logs.reduce((sum, l) => sum + l.hours, 0);
    totalEl.textContent = `Total: ${totalHours.toFixed(1)} hrs`;

    container.innerHTML = logs.map(log => `
        <div class="flex items-start gap-3 p-3 bg-white border border-gray-100 rounded-lg" id="log-row-${log.id}">
            <div class="flex-shrink-0 text-right min-w-[48px]">
                <span class="text-sm font-semibold text-amber-600">${log.hours.toFixed(1)}</span>
                <span class="text-xs text-gray-400 block">hrs</span>
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between gap-2">
                    <span class="text-xs font-medium text-gray-700 truncate">${log.name ? escHtml(log.name) : '(no summary)'}</span>
                    <span class="text-xs text-gray-400 flex-shrink-0">${log.date_formatted}</span>
                </div>
                ${log.description ? `<p class="text-xs text-gray-500 mt-0.5 truncate">${escHtml(log.description)}</p>` : ''}
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-gray-400">${escHtml(log.creator_name)}</span>
                    ${log.percent_complete !== null ? `<span class="text-xs text-blue-500">${log.percent_complete}%</span>` : ''}
                    ${log.costcode ? `<span class="text-xs text-gray-300">${escHtml(log.costcode)}</span>` : ''}
                    ${log.cost > 0 ? `<span class="text-xs text-gray-400">$${log.cost.toFixed(2)}</span>` : ''}
                    ${log.risk ? `<span class="text-xs" title="Red flag raised with this entry">ðŸš©</span>` : ''}
                </div>
            </div>
            <button onclick="deleteTaskLog(${log.id})"
                    class="flex-shrink-0 p-1 text-gray-300 hover:text-red-500 rounded transition-colors"
                    title="Delete this entry">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    `).join('');
}

function submitTaskLog() {
    const taskId = _logCurrentTaskId;
    if (!taskId) return;

    const hours   = parseFloat(document.getElementById('logHours').value);
    const date    = document.getElementById('logDate').value;
    const status  = document.getElementById('logSaveStatus');

    if (!hours || hours <= 0) {
        status.textContent = 'Please enter valid hours.';
        status.className = 'text-xs text-red-500';
        return;
    }
    if (!date) {
        status.textContent = 'Please select a date.';
        status.className = 'text-xs text-red-500';
        return;
    }

    status.textContent = 'Savingâ€¦';
    status.className = 'text-xs text-gray-400';

    const body = {
        task_log_hours:        hours,
        task_log_date:         date,
        task_log_name:         document.getElementById('logName').value || null,
        task_log_description:  document.getElementById('logDescription').value || null,
        task_log_costcode:     document.getElementById('logCostcode').value || null,
        task_percent_complete: document.getElementById('logPercent').value
                               ? parseInt(document.getElementById('logPercent').value) : null,
        task_log_risk:         document.getElementById('logRiskFlag').checked ? 1 : 0,
    };

    fetch(`/tasks/${taskId}/log-time`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept':       'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || '',
        },
        body: JSON.stringify(body),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            status.textContent = 'Saved!';
            status.className = 'text-xs text-green-600';

            // Clear hours field, keep date
            document.getElementById('logHours').value = '';
            document.getElementById('logName').value = '';
            document.getElementById('logDescription').value = '';
            document.getElementById('logPercent').value = '';

            // Reload log history
            loadTaskLogData(taskId);

            // Update task row flag + hours display without full page reload
            if (data.task) {
                updateTaskRowFlag(taskId, data.task.flagged, data.task.flag_tooltip);
                updateTaskRowHours(taskId, data.task.hours_worked, data.task.percent_complete);
            }

            // Reset flag checkbox after save
            document.getElementById('logRiskFlag').checked = false;

            setTimeout(() => { status.textContent = ''; }, 3000);
        } else {
            status.textContent = data.message || 'Save failed.';
            status.className = 'text-xs text-red-500';
        }
    })
    .catch(() => {
        status.textContent = 'Network error â€” please try again.';
        status.className = 'text-xs text-red-500';
    });
}

function deleteTaskLog(logId) {
    const taskId = _logCurrentTaskId;
    if (!taskId || !confirm('Delete this log entry?')) return;

    fetch(`/tasks/${taskId}/logs/${logId}`, {
        method: 'DELETE',
        headers: {
            'Accept':       'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || '',
        },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadTaskLogData(taskId);
        } else {
            alert(data.message || 'Delete failed.');
        }
    });
}

/**
 * Update the task row's hours display after logging time,
 * without requiring a full page reload.
 */
function updateTaskRowFlag(taskId, flagged, tooltip) {
    // Find col 2 (hours risk / flag slot) in the task row
    const row = document.querySelector(`[data-task-id="${taskId}"] .task-row-grid`);
    if (!row) return;
    // Easiest approach: add/remove a flag badge next to the row header
    // The full icon swap requires a page reload â€” mark row as stale instead
    const existingFlag = document.getElementById(`flag-badge-${taskId}`);
    if (flagged) {
        if (!existingFlag) {
            const badge = document.createElement('span');
            badge.id = `flag-badge-${taskId}`;
            badge.title = tooltip || 'ðŸš© Flag raised';
            badge.textContent = 'ðŸš©';
            badge.className = 'absolute top-1 left-1 text-xs leading-none pointer-events-none';
            const taskRow = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskRow) {
                taskRow.style.position = 'relative';
                taskRow.appendChild(badge);
            }
        }
    } else {
        if (existingFlag) existingFlag.remove();
    }
}

function updateTaskRowHours(taskId, hoursWorked, percentComplete) {
    // The hours and percent columns are rendered server-side,
    // so a lightweight approach is to mark the row as "stale"
    // and let the user know to refresh â€” OR we can update the visible text.
    // For now: add a visual indicator that data changed.
    const row = document.querySelector(`[data-task-id="${taskId}"]`);
    if (row) {
        row.style.outline = '2px solid #f59e0b';
        setTimeout(() => { row.style.outline = ''; }, 2000);
    }
}

function escHtml(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
              .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
</script>
